<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="1415" height="567" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[participant Server
participant Bob

Bob->Server: alice@xmpp.org

Server->Server: Group all prekey messages by instance tag
Server->Server: Filter out expired prekey messages from each group
Server->Server: Choose one prekey message from each group
Server->Bob: Send all selected prekey messages
Server->Server: Remove all sent prekey messages

Bob->Bob: Group all prekey messages by instance tag
Bob->Bob: Filter out invalid prekey messages (expired, for example) from each group
Bob->Bob: Choose the prekey message with the latest expiry time from each group
Bob->Bob: Choose to send messages to multiple instance tags and/or long-term keys
Bob->Bob: Decide if multiple conversations should be kept simultaneously]]></source><desc></desc><defs><marker viewBox="0 0 5 5" markerWidth="5" markerHeight="5" orient="auto" refX="5" refY="2.5" id="markerArrowBlock"><path d="M 0 0 L 5 2.5 L 0 5 z"></path></marker><marker viewBox="0 0 9.6 16" markerWidth="4" markerHeight="16" orient="auto" refX="9.6" refY="8" id="markerArrowOpen"><path d="M 9.6,8 1.92,16 0,13.7 5.76,8 0,2.286 1.92,0 9.6,8 z"></path></marker></defs><g class="title"></g><g class="actor"><rect x="10" y="20" width="80" height="39" style="stroke-width: 2;" stroke="#000000" fill="#ffffff"></rect><text x="20" y="45" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="20">Server</tspan></text></g><g class="actor"><rect x="10" y="508" width="80" height="39" style="stroke-width: 2;" stroke="#000000" fill="#ffffff"></rect><text x="20" y="533" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="20">Server</tspan></text></g><line x1="50" x2="50" y1="59" y2="508" style="stroke-width: 2;" stroke="#000000" fill="none"></line><g class="actor"><rect x="565" y="20" width="50" height="39" style="stroke-width: 2;" stroke="#000000" fill="#ffffff"></rect><text x="575" y="45" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="575">Bob</tspan></text></g><g class="actor"><rect x="565" y="508" width="50" height="39" style="stroke-width: 2;" stroke="#000000" fill="#ffffff"></rect><text x="575" y="533" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="575">Bob</tspan></text></g><line x1="590" x2="590" y1="59" y2="508" style="stroke-width: 2;" stroke="#000000" fill="none"></line><g class="signal"><text x="250" y="89.5" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="250">alice@xmpp.org</tspan></text><line x1="590" x2="50" y1="98" y2="98" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="75" y="132.5" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="75">Group all prekey messages by instance tag</tspan></text><line x1="50" x2="70" y1="118" y2="118" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="70" x2="70" y1="118" y2="142" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="70" x2="50" y1="142" y2="142" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="75" y="171.5" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="75">Filter out expired prekey messages from each group</tspan></text><line x1="50" x2="70" y1="157" y2="157" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="70" x2="70" y1="157" y2="181" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="70" x2="50" y1="181" y2="181" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="75" y="210.5" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="75">Choose one prekey message from each group</tspan></text><line x1="50" x2="70" y1="196" y2="196" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="70" x2="70" y1="196" y2="220" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="70" x2="50" y1="220" y2="220" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="155" y="245.5" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="155">Send all selected prekey messages</tspan></text><line x1="50" x2="590" y1="254" y2="254" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="75" y="288.5" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="75">Remove all sent prekey messages</tspan></text><line x1="50" x2="70" y1="274" y2="274" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="70" x2="70" y1="274" y2="298" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="70" x2="50" y1="298" y2="298" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="615" y="327.5" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="615">Group all prekey messages by instance tag</tspan></text><line x1="590" x2="610" y1="313" y2="313" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="610" x2="610" y1="313" y2="337" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="610" x2="590" y1="337" y2="337" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="615" y="366.5" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="615">Filter out invalid prekey messages (expired, for example) from each group</tspan></text><line x1="590" x2="610" y1="352" y2="352" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="610" x2="610" y1="352" y2="376" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="610" x2="590" y1="376" y2="376" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="615" y="405.5" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="615">Choose the prekey message with the latest expiry time from each group</tspan></text><line x1="590" x2="610" y1="391" y2="391" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="610" x2="610" y1="391" y2="415" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="610" x2="590" y1="415" y2="415" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="615" y="444.5" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="615">Choose to send messages to multiple instance tags and/or long-term keys</tspan></text><line x1="590" x2="610" y1="430" y2="430" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="610" x2="610" y1="430" y2="454" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="610" x2="590" y1="454" y2="454" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="615" y="483.5" style="font-size: 16px; font-family: Andale\ Mono, monospace;"><tspan x="615">Decide if multiple conversations should be kept simultaneously</tspan></text><line x1="590" x2="610" y1="469" y2="469" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="610" x2="610" y1="469" y2="493" style="stroke-width: 2;" stroke="#000000" fill="none"></line><line x1="610" x2="590" y1="493" y2="493" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g></svg>
